# Инструкция по настройке фильтров для каталога книг

## Что было сделано

### 1. Обновление модели данных

#### models/book.py
- Добавлено поле `publisher` (издательство)
- Добавлено поле `binding` (переплёт)
- Обновлён метод `to_dict()` для включения новых полей в API

#### parsers/base.py
- Обновлён класс `Book` для включения полей `publisher` и `binding`

### 2. Обновление парсера

#### parsers/chitai_gorod.py
- Добавлен метод `_extract_book_characteristics()` для извлечения:
  - Издательства из таблиц характеристик
  - Переплёта из таблиц характеристик
  - Нормализация значений переплёта (Мягкий, Твердый, Суперобложка, Интегральный)
- Обновлён метод `parse_book_page()` для сохранения новых данных

### 3. Обновление сохранения данных

#### services/celery_tasks.py
- Обновлён метод `_save_book()` для сохранения полей `publisher` и `binding`

### 4. Обновление пользовательского интерфейса

#### web/templates/books/list.html
- Добавлен фильтр по жанру (выпадающий список, заполняется динамически)
- Добавлен фильтр по издательству (выпадающий список, заполняется динамически)
- Добавлен фильтр по переплёту (выпадающий список с предопределёнными значениями)
- Обновлён JavaScript для работы с новыми фильтрами
- Добавлена функция `populateFilterOptions()` для заполнения выпадающих списков

### 5. Миграция базы данных

#### alembic/versions/003_add_publisher_and_binding.py
- Создана миграция для добавления полей `publisher` и `binding` в таблицу `books`
- Созданы индексы для оптимизации поиска по этим полям

## Как запустить миграцию

### Шаг 1: Проверьте текущую схему базы данных
```bash
python check_db_schema.py
```

Ожидаемый результат:
```
Current columns in books table (SQLite):
  id: INTEGER
  title: VARCHAR(500)
  author: VARCHAR(255)
  current_price: NUMERIC
  original_price: NUMERIC
  discount_percent: INTEGER
  url: VARCHAR
  image_url: VARCHAR
  genres: VARCHAR
  source: VARCHAR
  source_id: VARCHAR
  parsed_at: DATETIME
```

### Шаг 2: Примените миграцию
```bash
alembic upgrade head
```

### Шаг 3: Проверьте, что миграция прошла успешно
```bash
python check_db_schema.py
```

Ожидаемый результат:
```
Current columns in books table (SQLite):
  id: INTEGER
  title: VARCHAR(500)
  author: VARCHAR(255)
  publisher: VARCHAR(255)  # НОВОЕ
  binding: VARCHAR(100)    # НОВОЕ
  current_price: NUMERIC
  original_price: NUMERIC
  discount_percent: INTEGER
  url: VARCHAR
  image_url: VARCHAR
  genres: VARCHAR
  source: VARCHAR
  source_id: VARCHAR
  parsed_at: DATETIME
```

## Как протестировать

### 1. Тест парсинга издательства и переплёта
```bash
python test_publisher_binding_parsing.py
```

Ожидаемый результат:
```
============================================================
ТЕСТ ПАРСИНГА ИЗДАТЕЛЬСТВА И ПЕРЕПЛЁТА
============================================================

Тест 1: Издательство и переплёт в таблице
------------------------------------------------------------
Ожидается: издательство='Эксмо', переплёт='Твердый'
Получено:   издательство='Эксмо', переплёт='Твердый'
✅ ТЕСТ ПРОЙДЕН

...
============================================================
РЕЗУЛЬТАТЫ: X пройдено, 0 не пройдено
============================================================
```

### 2. Тест фильтрации в веб-интерфейсе
1. Запустите приложение
2. Перейдите на страницу каталога книг
3. Проверьте, что появились новые фильтры:
   - Жанр (выпадающий список)
   - Издательство (выпадающий список)
   - Переплёт (выпадающий список)
4. Выберите фильтр и проверьте, что результаты фильтруются корректно
5. Проверьте, что фильтр "Любой" показывает все книги

## Как работают фильтры

### Жанр
- Заполняется динамически на основе жанров всех книг в каталоге
- При выборе жанра показываются только книги, у которых есть этот жанр
- Если выбрано "Любой", показываются все книги

### Издательство
- Заполняется динамически на основе издательств всех книг в каталоге
- При выборе издательства показываются только книги этого издательства
- Если выбрано "Любое", показываются все книги

### Переплёт
- Имеет предопределённые значения:
  - Любой
  - Мягкий
  - Твердый
  - Суперобложка
  - Интегральный
- При выборе типа переплёта показываются только книги с этим типом
- Если выбрано "Любой", показываются все книги

## Обработка ошибок и отсутствия данных

### При парсинге
- Если издательство не найдено в HTML → сохраняется `None`
- Если переплёт не найден в HTML → сохраняется `None`
- Если происходит ошибка при извлечении → сохраняется `None`

### При фильтрации
- Если выбран фильтр "Любой" → показываются все книги, включая те, у которых нет значения
- Если выбран конкретный фильтр → показываются только книги, у которых есть соответствующее значение
- Книги без значения для фильтра не показываются при активном фильтре

## Нормализация данных

### Переплёт (binding)
Парсер автоматически нормализует значения переплёта:

| Исходное значение | Нормализованное значение |
|------------------|-------------------------|
| мягкий, мягк, мягкая | Мягкий |
| твердый, тверд, твёрдый, твёрд | Твердый |
| супер, super | Суперобложка |
| интегральный, integral | Интегральный |
| Остальные значения | Сохраняются как есть (обрезаются до 100 символов) |

### Издательство (publisher)
- Сохраняется как есть (обрезается до 255 символов)
- Приводится к нижнему регистру при фильтрации для регистронезависимого поиска

## Обратная совместимость

- Старые записи в базе данных будут иметь `NULL` в новых полях
- При фильтрации по жанру/издательству/переплёту старые записи не будут показываться при активном фильтре
- Фильтр "Любой" показывает все записи, включая старые

## Дальнейшие улучшения

1. **Добавить больше источников данных**
   - Поддержать парсинг издательства и переплёта для других источников (Ozon, Wildberries, Лабиринт)

2. **Улучшить нормализацию данных**
   - Создать словарь синонимов для издательств (например, "Издательство АСТ", "АСТ", "АСТ.ПРЕСС" → "АСТ")
   - Создать более детальную классификацию переплётов

3. **Добавить дополнительные фильтры**
   - Год издания
   - Количество страниц
   - Язык
   - Возрастные ограничения

4. **Оптимизация производительности**
   - Добавить кеширование для фильтров
   - Оптимизировать запросы к базе данных для больших каталогов

## Возможные проблемы и решения

### Проблема: Миграция не применяется
**Решение:**
```bash
alembic upgrade head
```

### Проблема: Фильтры не работают
**Решение:**
- Проверьте, что миграция применена успешно
- Проверьте консоль браузера на наличие ошибок JavaScript
- Проверьте, что данные в базе данных содержат значения для полей `publisher` и `binding`

### Проблема: Выпадающие списки пустые
**Решение:**
- Проверьте, что в базе данных есть книги с заполненными полями `genres`, `publisher`, `binding`
- Проверьте консоль браузера на наличие ошибок JavaScript

### Проблема: Парсер не извлекает издательство или переплёт
**Решение:**
- Проверьте HTML структуру страницы книги
- Обновите метод `_extract_book_characteristics()` для поддержки новой структуры
- Проверьте логи парсера на наличие ошибок
