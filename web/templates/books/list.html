{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="hero-section text-center py-4">
                <h1 class="display-5 mb-2">
                    <i class="fas fa-search"></i> –ö–∞—Ç–∞–ª–æ–≥ –∫–Ω–∏–≥
                </h1>
                <p class="lead mb-0">–ù–∞–π–¥–∏—Ç–µ –ª—É—á—à–∏–µ –∫–Ω–∏–≥–∏ –ø–æ –ª—É—á—à–∏–º —Ü–µ–Ω–∞–º</p>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="search-container">
                <!-- Smart Search -->
                <div class="row mb-4">
                    <div class="col-lg-8">
                        <form id="smartSearchForm" class="d-flex gap-2">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control search-input" 
                                       id="searchQuery" name="q" 
                                       placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä..."
                                       value="{{ request.query_params.get('q', '') }}">
                                <button class="btn btn-primary" type="submit" id="searchBtn">
                                    <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="col-lg-4 d-flex align-items-end">
                        <button id="showAllBtn" class="btn btn-outline-primary w-100">
                            <i class="fas fa-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏
                        </button>
                    </div>
                    
                    <!-- Search Status -->
                    <div id="searchStatus" class="mt-3"></div>
                </div>

                <!-- Advanced Filters -->
                <div class="filter-section">
                    <h6 class="mb-3">
                        <i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä—ã
                    </h6>
                    
                    <div class="row">
                        <!-- Price Filter -->
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–¶–µ–Ω–∞ –¥–æ (‚ÇΩ)</label>
                            <input type="number" class="form-control" id="priceFilter" 
                                   placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500" min="0" step="10">
                            <small class="text-muted">–ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ü–µ–Ω—ã –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ</small>
                        </div>
                        
                        <!-- Discount Filter -->
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–°–∫–∏–¥–∫–∞ –æ—Ç (%)</label>
                            <select class="form-select" id="discountFilter">
                                <option value="">–õ—é–±–∞—è</option>
                                <option value="10">10% –∏ –±–æ–ª—å—à–µ</option>
                                <option value="20">20% –∏ –±–æ–ª—å—à–µ</option>
                                <option value="30">30% –∏ –±–æ–ª—å—à–µ</option>
                                <option value="40">40% –∏ –±–æ–ª—å—à–µ</option>
                                <option value="50">50% –∏ –±–æ–ª—å—à–µ</option>
                            </select>
                        </div>
                        
                        <!-- Sort Options -->
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
                            <select class="form-select" id="sortFilter">
                                <option value="price_asc">–¶–µ–Ω–∞: –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                                <option value="price_desc">–¶–µ–Ω–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                <option value="discount_desc">–°–∫–∏–¥–∫–∞: –ø–æ —É–±—ã–≤–∞–Ω–∏—é</option>
                                <option value="date_desc">–î–∞—Ç–∞: –Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞</option>
                                <option value="title_asc">–ù–∞–∑–≤–∞–Ω–∏–µ: –ê-–Ø</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Store Multi-select -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label class="filter-label">–ú–∞–≥–∞–∑–∏–Ω—ã</label>
                            <div class="multiple-select" id="storesFilter">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="chitai-gorod" 
                                           id="store-chitai-gorod" checked>
                                    <label class="form-check-label" for="store-chitai-gorod">
                                        –ß–∏—Ç–∞–π-–≥–æ—Ä–æ–¥
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="ozon" 
                                           id="store-ozon">
                                    <label class="form-check-label" for="store-ozon">
                                        –û–∑–æ–Ω
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="wildberries" 
                                           id="store-wildberries">
                                    <label class="form-check-label" for="store-wildberries">
                                        Wildberries
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="checkbox" value="labirint" 
                                           id="store-labirint">
                                    <label class="form-check-label" for="store-labirint">
                                        –õ–∞–±–∏—Ä–∏–Ω—Ç
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Genre Filter -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–ñ–∞–Ω—Ä</label>
                            <select class="form-select" id="genreFilter">
                                <option value="">–õ—é–±–æ–π</option>
                            </select>
                        </div>
                        
                        <!-- Publisher Filter -->
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ</label>
                            <select class="form-select" id="publisherFilter">
                                <option value="">–õ—é–±–æ–µ</option>
                            </select>
                        </div>

                        <!-- Binding Filter -->
                        <div class="col-md-4 mb-3">
                            <label class="filter-label">–ü–µ—Ä–µ–ø–ª—ë—Ç</label>
                            <select class="form-select" id="bindingFilter">
                                <option value="">–õ—é–±–æ–π</option>
                                <option value="–ú—è–≥–∫–∏–π">–ú—è–≥–∫–∏–π</option>
                                <option value="–¢–≤–µ—Ä–¥—ã–π">–¢–≤–µ—Ä–¥—ã–π</option>
                                <option value="–°—É–ø–µ—Ä–æ–±–ª–æ–∂–∫–∞">–°—É–ø–µ—Ä–æ–±–ª–æ–∂–∫–∞</option>
                                <option value="–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π">–ò–Ω—Ç–µ–≥—Ä–∞–ª—å–Ω—ã–π</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Books Grid -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 id="resultsTitle">
                    <i class="fas fa-book"></i> 
                    <span id="booksCount">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="clearFilters">
                        <i class="fas fa-times"></i> –û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                    </button>
                </div>
            </div>
            
            <!-- Books Container -->
            <div id="booksContainer">
                <!-- Books Per Page Info -->
                <div id="booksPerPageInfo" class="books-per-page-info" style="display: none;">
                    <i class="fas fa-info-circle"></i> 
                    –ü–æ–∫–∞–∑–∞–Ω–æ <span id="shownBooksCount">0</span> –∏–∑ <span id="totalBooksCount">0</span> –∫–Ω–∏–≥
                </div>
                
                <!-- Loading State -->
                <div id="loadingState" class="text-center py-5">
                    <div class="book-loading">
                        <p>–ó–∞–≥—Ä—É–∂–∞–µ–º –∫–Ω–∏–≥–∏...</p>
                    </div>
                </div>
                
                <!-- Books Grid -->
                <div id="booksGrid" class="books-grid-5" style="display: none;">
                    <!-- Books will be loaded here via JavaScript -->
                </div>
                
                <!-- Pagination -->
                <div id="paginationContainer" class="pagination-container" style="display: none;">
                    <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
                        <ul class="pagination" id="pagination">
                            <!-- Pagination will be loaded here via JavaScript -->
                        </ul>
                    </nav>
                    <div class="pagination-info" id="paginationInfo">
                        <!-- Pagination info will be loaded here -->
                    </div>
                </div>
                
                <!-- No Results State -->
                <div id="noResults" class="text-center py-5" style="display: none;">
                    <i class="fas fa-search fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h4>
                    <p class="text-muted mb-4">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–∏—Å–∫–∞</p>
                    <button class="btn btn-primary" id="showAllBooksBtn">
                        <i class="fas fa-list"></i> –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–Ω–∏–≥–∏
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Book Details Modal -->
<div class="modal fade" id="bookDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-book"></i> –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–Ω–∏–≥–µ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookDetailsContent">
                <!-- Book details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Subscribe Modal -->
<div class="modal fade" id="subscribeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-bell"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="subscribeForm">
                    <div class="mb-3">
                        <label class="form-label">–ö–Ω–∏–≥–∞</label>
                        <input type="text" class="form-control" id="subscribeBookTitle" readonly>
                        <input type="hidden" id="subscribeBookId">
                        <input type="hidden" id="subscribeBookUrl">
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–¶–µ–ª–µ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
                        <input type="number" class="form-control" id="subscribePrice" 
                               placeholder="–£–∫–∞–∂–∏—Ç–µ –∂–µ–ª–∞–µ–º—É—é —Ü–µ–Ω—É" min="1" required>
                        <small class="text-muted">–í—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ —Ü–µ–Ω–∞ —Å—Ç–∞–Ω–µ—Ç —Ä–∞–≤–Ω–æ–π –∏–ª–∏ –Ω–∏–∂–µ —É–∫–∞–∑–∞–Ω–Ω–æ–π</small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">–£–≤–µ–¥–æ–º–ª—è—Ç—å –æ —Å–∫–∏–¥–∫–∞—Ö –æ—Ç (%)</label>
                        <input type="number" class="form-control" id="subscribeDiscount" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 20" min="1" max="100">
                        <small class="text-muted">–ù–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ. –£–≤–µ–¥–æ–º–ª—è—Ç—å –ø—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ % —Å–∫–∏–¥–∫–∏</small>
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            –û—Ç–º–µ–Ω–∞
                        </button>
                        <button type="submit" class="btn btn-subscribe">
                            <i class="fas fa-bell"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add alert container if not exists
    addAlertContainer();
    
    // State management
    let currentBooks = [];
    let filteredBooks = [];
    let isLoading = false;
    let userAlerts = {}; // –•—Ä–∞–Ω–∏—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ book_id
    
    // Pagination state
    let currentPage = 1;
    const booksPerPage = 50;
    let totalPages = 1;
    let currentPageBooks = [];
    
    // DOM Elements
    const searchForm = document.getElementById('smartSearchForm');
    const searchQuery = document.getElementById('searchQuery');
    const searchBtn = document.getElementById('searchBtn');
    const searchStatus = document.getElementById('searchStatus');
    const showAllBtn = document.getElementById('showAllBtn');
    const priceFilter = document.getElementById('priceFilter');
    const discountFilter = document.getElementById('discountFilter');
    const sortFilter = document.getElementById('sortFilter');
    const storesFilter = document.getElementById('storesFilter');
    const clearFiltersBtn = document.getElementById('clearFilters');
    const booksGrid = document.getElementById('booksGrid');
    const booksContainer = document.getElementById('booksContainer');
    const loadingState = document.getElementById('loadingState');
    const noResults = document.getElementById('noResults');
    const booksCount = document.getElementById('booksCount');
    const resultsTitle = document.getElementById('resultsTitle');
    
    // Pagination elements
    const booksPerPageInfo = document.getElementById('booksPerPageInfo');
    const shownBooksCount = document.getElementById('shownBooksCount');
    const totalBooksCount = document.getElementById('totalBooksCount');
    const paginationContainer = document.getElementById('paginationContainer');
    const pagination = document.getElementById('pagination');
    const paginationInfo = document.getElementById('paginationInfo');
    
    // Modal elements
    const bookDetailsModal = new bootstrap.Modal(document.getElementById('bookDetailsModal'));
    const subscribeModal = new bootstrap.Modal(document.getElementById('subscribeModal'));
    const subscribeForm = document.getElementById('subscribeForm');
    
    // Initialize page
    loadAllBooksWithAlerts();
    
    // Event Listeners
    searchForm.addEventListener('submit', handleSmartSearch);
    showAllBtn.addEventListener('click', loadAllBooks);
    document.getElementById('showAllBooksBtn').addEventListener('click', loadAllBooks);
    clearFiltersBtn.addEventListener('click', clearAllFilters);
    
    // Filter event listeners
    [priceFilter, discountFilter, sortFilter].forEach(element => {
        element.addEventListener('change', applyFilters);
    });
    
    // Store filter listeners
    storesFilter.addEventListener('change', applyFilters);
    
    // New filters listeners
    document.getElementById('genreFilter').addEventListener('change', applyFilters);
    document.getElementById('publisherFilter').addEventListener('change', applyFilters);
    document.getElementById('bindingFilter').addEventListener('change', applyFilters);
    
    // Subscribe form
    subscribeForm.addEventListener('submit', handleSubscribe);
    
    // Reset form when modal is hidden
    subscribeModal._element.addEventListener('hidden.bs.modal', function () {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏ —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
        const submitBtn = document.querySelector('#subscribeForm button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-bell"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
        
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        subscribeForm.reset();
    });
    
    // Functions
    async function loadAllBooks() {
        showLoading();
        
        try {
            const response = await fetch('/web/books/api/all');
            if (response.ok) {
                const data = await response.json();
                currentBooks = data.books || [];
                
                // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –ø—Ä–∏ –ø–æ–∫–∞–∑–µ –≤—Å–µ—Ö –∫–Ω–∏–≥
                searchQuery.value = '';
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—Å–µ—Ö –∫–Ω–∏–≥
                resetFilters();
                applyFilters();
                hideLoading();
            } else {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥: ' + error.message);
        }
    }
    
    async function loadAllBooksWithAlerts() {
        showLoading();
        
        try {
            const response = await fetch('/web/books/api/all');
            if (response.ok) {
                const data = await response.json();
                currentBooks = data.books || [];
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–∏–≥
                await loadUserAlerts();
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
                populateFilterOptions();

                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤—Å–µ—Ö –∫–Ω–∏–≥
                resetFilters();
                applyFilters();
                hideLoading();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–Ω–∏–≥–∏
                checkUrlForAutoBookDetails();
            } else {
                throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥:', error);
            showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–Ω–∏–≥: ' + error.message);
        }
    }
    
    async function loadUserAlerts() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–ø–∏—Å–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–Ω–∏–≥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            await loadAlertsForBooks();
        } catch (error) {
            console.log('–ü–æ–¥–ø–∏—Å–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã:', error.message);
        }
    }
    
    function populateFilterOptions() {
        console.log('üîç –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã. –ö–Ω–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω–æ:', currentBooks.length);

        // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∂–∞–Ω—Ä—ã
        const genresSet = new Set();
        currentBooks.forEach(book => {
            try {
                // genres –º–æ–∂–µ—Ç –±—ã—Ç—å JSON-—Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
                let genres = book.genres;
                if (typeof genres === 'string') {
                    genres = JSON.parse(genres);
                }
                if (Array.isArray(genres)) {
                    genres.forEach(genre => {
                        if (genre && genre.trim()) {
                            genresSet.add(genre.trim());
                        }
                    });
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –∂–∞–Ω—Ä–æ–≤ –¥–ª—è –∫–Ω–∏–≥–∏', book.title, ':', e);
            }
        });

        // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞
        const publishersSet = new Set();
        currentBooks.forEach(book => {
            const publisher = book.publisher;
            if (publisher && publisher.trim()) {
                publishersSet.add(publisher.trim());
            }
        });

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∂–∞–Ω—Ä–æ–≤
        const genreFilter = document.getElementById('genreFilter');
        if (genreFilter) {
            genreFilter.innerHTML = '<option value="">–õ—é–±–æ–π</option>';
            Array.from(genresSet).sort().forEach(genre => {
                const option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreFilter.appendChild(option);
            });
        }

        // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤
        const publisherFilter = document.getElementById('publisherFilter');
        if (publisherFilter) {
            publisherFilter.innerHTML = '<option value="">–õ—é–±–æ–µ</option>';
            Array.from(publishersSet).sort().forEach(publisher => {
                const option = document.createElement('option');
                option.value = publisher;
                option.textContent = publisher;
                publisherFilter.appendChild(option);
            });
        }

        console.log(`‚úÖ –ó–∞–ø–æ–ª–Ω–µ–Ω–æ ${genresSet.size} –∂–∞–Ω—Ä–æ–≤ –∏ ${publishersSet.size} –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤`);
    }
    
    async function loadAlertsForBooks() {
        if (!currentBooks.length) return;
        
        try {
            console.log(`Loading alerts for ${currentBooks.length} books...`);
            
            // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–º–∏—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω–∞ –∫–∞–∂–¥—É—é –∫–Ω–∏–≥—É
            const alertPromises = currentBooks.map(async (book) => {
                try {
                    const response = await fetch(`/api/alerts/book/${book.id}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.alert) {
                            userAlerts[book.id] = data.alert;
                            console.log(`Found subscription for book ${book.id}: ${data.alert.book_title}`);
                        } else {
                            console.log(`No subscription for book ${book.id}: ${book.title}`);
                        }
                    }
                } catch (error) {
                    // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–Ω–∏–≥
                    console.debug(`Failed to load subscription for book ${book.id}:`, error.message);
                }
            });
                        
            // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ (–Ω–æ –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)
            await Promise.allSettled(alertPromises);
            
            console.log(`Loaded user alerts:`, userAlerts);
            
        } catch (error) {
            console.debug('Error loading subscriptions:', error.message);
        }
    }
    
    function showEditSubscriptionModal(bookId) {
        const alert = userAlerts[bookId];
        if (!alert) return;
        
        const book = currentBooks.find(b => b.id === bookId);
        if (!book) return;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ø–æ–¥–ø–∏—Å–∫–∏
        document.getElementById('subscribeBookTitle').value = `${book.title} - ${book.author}`;
        document.getElementById('subscribeBookId').value = book.id;
        document.getElementById('subscribeBookUrl').value = book.url || '';
        document.getElementById('subscribePrice').value = alert.target_price;
        document.getElementById('subscribeDiscount').value = alert.min_discount || '';
        
        // –ò–∑–º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        const submitBtn = document.querySelector('#subscribeForm button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-edit"></i> –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –∏–∑–º–µ–Ω—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã
        const originalHandler = handleSubscribe;
        handleSubscribe = async function(event) {
            event.preventDefault();
            
            const formData = {
                target_price: parseFloat(document.getElementById('subscribePrice').value),
                min_discount: document.getElementById('subscribeDiscount').value ? 
                    parseFloat(document.getElementById('subscribeDiscount').value) : null
            };
            
            try {
                const response = await fetch(`/api/alerts/book/${bookId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showAlert('–ü–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                    subscribeModal.hide();
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∫–Ω–æ–ø–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    if (result.alert) {
                        userAlerts[bookId] = result.alert;
                        updateSubscriptionButton(bookId);
                    }
                    
                    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
                    handleSubscribe = originalHandler;
                    submitBtn.innerHTML = originalText;
                } else {
                    const error = await response.json();
                    showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error);
                showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ' + error.message, 'danger');
            }
        };
        
        subscribeModal.show();
    }
    
    async function handleSmartSearch(event) {
        event.preventDefault();
        
        const query = searchQuery.value.trim();
        if (!query) {
            loadAllBooks();
            return;
        }
        
        showLoading();
        
        try {
            // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
            const searchResponse = await fetch(`/web/books/api/search?q=${encodeURIComponent(query)}`);
            const searchData = await searchResponse.json();
            
            if (searchData.books && searchData.books.length > 0) {
                // –ö–Ω–∏–≥–∏ –Ω–∞–π–¥–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                currentBooks = searchData.books;
                showSearchStatus(`–ù–∞–π–¥–µ–Ω–æ ${currentBooks.length} –∫–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ`, 'success');
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
                resetFilters();
                applyFilters();
            } else {
                // –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –∑–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
                showSearchStatus('–ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ. –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫...', 'info');
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ —Å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
                const parseResponse = await fetch('/api/parser/parse-body', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        source: 'chitai-gorod',
                        fetch_details: true  // –í–∫–ª—é—á–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ (–∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ, –ø–µ—Ä–µ–ø–ª—ë—Ç, –∂–∞–Ω—Ä—ã)
                    })
                });
                
                if (parseResponse.ok) {
                    const parseData = await parseResponse.json();
                    showSearchStatus(`üîç –ò—â–µ–º –∫–Ω–∏–≥–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}" –Ω–∞ —Å–∞–π—Ç–µ chitai-gorod.ru...`, 'info');
                    
                    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–∞—Ä—Å–∏–Ω–≥–∞
                    trackParsingProgress(parseData.task_id, query);
                } else {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫');
                }
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            showSearchStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'danger');
        } finally {
            hideLoading();
        }
    }
    
    async function trackParsingProgress(taskId, query) {
        let attempts = 0;
        const maxAttempts = 30; // 5 –º–∏–Ω—É—Ç
        
        const checkProgress = async () => {
            try {
                attempts++;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                if (attempts === 1) {
                    showSearchStatus(`üîç –°–∫–∞–Ω–∏—Ä—É–µ–º —Å–∞–π—Ç chitai-gorod.ru –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"...`, 'info');
                } else if (attempts === 2) {
                    showSearchStatus(`üìö –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞...`, 'info');
                } else if (attempts === 3) {
                    showSearchStatus(`‚è≥ –ü–æ–∏—Å–∫ –ø–æ—á—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω, –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ...`, 'info');
                }
                
                const response = await fetch(`/api/parser/parse/${taskId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ë–î –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞
                        showSearchStatus(`‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω! –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...`, 'info');
                        
                        // –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
                        setTimeout(async () => {
                            try {
                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫–Ω–∏–≥ –ø–æ –∑–∞–ø—Ä–æ—Å—É
                                const dbResponse = await fetch(`/api/parser/books/${encodeURIComponent(query)}`);
                                
                                if (dbResponse.ok) {
                                    const dbData = await dbResponse.json();
                                    const dbBooksCount = dbData.total || 0;
                                    const books = dbData.books || [];
                                    
                                    console.log(`–ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î: –Ω–∞–π–¥–µ–Ω–æ ${dbBooksCount} –∫–Ω–∏–≥ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ "${query}"`);
                                    
                                    if (dbBooksCount > 0) {
                                        // –ö–ù–ò–ì–ò –ù–ê–ô–î–ï–ù–´ –í –ë–î - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                        showSearchStatus(`–ù–∞–π–¥–µ–Ω–æ ${dbBooksCount} –∫–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ`, 'success');
                                        
                                        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–∏–≥–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥
                                        addNewBooksToCatalog(books, query);
                                        
                                    } else {
                                        // –ö–ù–ò–ì–ò –ù–ï –ù–ê–ô–î–ï–ù–´ –í –ë–î - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                                        const booksFound = data.result?.books_found || 0;
                                        
                                        showSearchStatus(`üîç –ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ: ${booksFound} –∫–Ω–∏–≥ —Å–æ —Å–∫–∏–¥–∫–æ–π. –ö–Ω–∏–≥–∏ –ø–æ –¥–∞–Ω–Ω–æ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`, 'warning');
                                    }
                                } else {
                                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î:', dbResponse.status);
                                    showSearchStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${dbResponse.status}`, 'danger');
                                }
                            } catch (error) {
                                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ë–î:', error);
                                showSearchStatus(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'danger');
                            }
                        }, 2000); // –ñ–¥–µ–º 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
                        
                    } else if (data.status === 'failed') {
                        showSearchStatus(`‚ùå –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π: ${data.message}`, 'danger');
                    } else {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ
                        if (attempts < maxAttempts) {
                            setTimeout(checkProgress, 10000);
                        } else {
                            showSearchStatus('‚è∞ –ü–æ–∏—Å–∫ –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å.', 'warning');
                        }
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞:', error);
                if (attempts < maxAttempts) {
                    setTimeout(checkProgress, 10000);
                }
            }
        };
        
        setTimeout(checkProgress, 5000);
    }
    
    async function addNewBooksToCatalog(newBooks, searchTerm) {
        try {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –Ω–∞–π–¥–µ–Ω—ã –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏
            if (newBooks.length === 0) {
                // –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ
                showSearchStatus(`üîç –ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ: 0 –∫–Ω–∏–≥ —Å–æ —Å–∫–∏–¥–∫–æ–π. –ö–Ω–∏–≥–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}" –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.`, 'warning');
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏ (–∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ—Ç –≤ –∫–∞—Ç–∞–ª–æ–≥–µ)
            const existingBookIds = currentBooks.map(book => book.id);
            const reallyNewBooks = newBooks.filter(book => !existingBookIds.includes(book.id));
            
            if (reallyNewBooks.length > 0) {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏ –≤ –º–∞—Å—Å–∏–≤ —Ç–µ–∫—É—â–∏—Ö –∫–Ω–∏–≥
                currentBooks = [...currentBooks, ...reallyNewBooks];
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
                searchQuery.value = searchTerm;
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
                priceFilter.value = '';
                discountFilter.value = '';
                sortFilter.value = 'price_asc';
                
                // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥
                const checkboxes = storesFilter.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = true;
                });
                
                currentPage = 1; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã - —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∫–Ω–∏–≥–∏ –ø–æ —Ç–µ–∫—É—â–µ–º—É –∑–∞–ø—Ä–æ—Å—É
                applyFilters();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∞—Ö
                setTimeout(() => {
                    showSearchStatus(`üéâ –£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ ${reallyNewBooks.length} –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${searchTerm}"!`, 'success');
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        showSearchStatus('', ''); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç—É—Å
                    }, 5000);
                }, 1000);
                
                console.log(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${reallyNewBooks.length} –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥`);
            }
            // –ï—Å–ª–∏ reallyNewBooks.length === 0, —Ç–æ –∫–Ω–∏–≥–∏ –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ, 
            // –Ω–æ –æ–Ω–∏ —É–∂–µ –µ—Å—Ç—å –≤ –∫–∞—Ç–∞–ª–æ–≥–µ - –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∏–∫–∞–∫–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è,
            // –ø–æ—Ç–æ–º—É —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö —É–∂–µ –≤–∏–¥–∏—Ç
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥:', error);
            showSearchStatus('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥', 'danger');
        }
    }
    
    function applyFilters() {
        let filtered = [...currentBooks];
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫–æ–≤–æ–º—É –∑–∞–ø—Ä–æ—Å—É
        const searchTerm = searchQuery.value.trim().toLowerCase();
        if (searchTerm) {
            filtered = filtered.filter(book => {
                const title = book.title ? book.title.toLowerCase() : '';
                const author = book.author ? book.author.toLowerCase() : '';
                
                // –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–ª–æ–≤–∞ –∏ –æ—á–∏—â–∞–µ–º –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
                const searchWords = searchTerm.split(/\s+/).map(word => {
                    // –£–¥–∞–ª—è–µ–º –∑–∞–ø—è—Ç—ã–µ, —Ç–æ—á–∫–∏ –∏ –¥—Ä—É–≥–∏–µ –∑–Ω–∞–∫–∏ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
                    return word.replace(/[,\.\!\?\:\;\-\‚Äî\(\)\[\]\{\}<>]/g, '').trim();
                }).filter(word => word.length > 0);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ —Å–ª–æ–≤–∞ –ø–æ–∏—Å–∫–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä–µ
                return searchWords.every(word => 
                    title.includes(word) || author.includes(word)
                );
            });
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã
        const price = priceFilter.value ? parseFloat(priceFilter.value) : null;
        const discount = discountFilter.value ? parseFloat(discountFilter.value) : null;
        const sortBy = sortFilter.value;
        const genreFilter = document.getElementById('genreFilter');
        const publisherFilter = document.getElementById('publisherFilter');
        const bindingFilter = document.getElementById('bindingFilter');
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Ü–µ–Ω–µ (–¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π —Ü–µ–Ω—ã –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ)
        if (price !== null) {
            filtered = filtered.filter(book => book.current_price <= price);
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ —Å–∫–∏–¥–∫–µ (–æ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ %)
        if (discount !== null) {
            filtered = filtered.filter(book => book.discount_percent && Math.abs(book.discount_percent) >= discount);
        }
        
        // –§–∏–ª—å—Ç—Ä –ø–æ –∂–∞–Ω—Ä—É
        if (genreFilter && genreFilter.value) {
            filtered = filtered.filter(book => {
                try {
                    let genres = book.genres || [];
                    // genres –º–æ–∂–µ—Ç –±—ã—Ç—å JSON-—Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
                    if (typeof genres === 'string') {
                        genres = JSON.parse(genres);
                    }
                    const selectedGenre = genreFilter.value;

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∂–∞–Ω—Ä –≤ —Å–ø–∏—Å–∫–µ –∂–∞–Ω—Ä–æ–≤ –∫–Ω–∏–≥–∏
                    if (Array.isArray(genres)) {
                        return genres.some(genre => genre && genre === selectedGenre);
                    }
                    return false;
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –∂–∞–Ω—Ä—É –¥–ª—è –∫–Ω–∏–≥–∏', book.title, ':', e);
                    return false;
                }
            });
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤—É
        if (publisherFilter && publisherFilter.value) {
            filtered = filtered.filter(book => {
                const publisher = book.publisher || '';
                const selectedPublisher = publisherFilter.value;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ
                return publisher === selectedPublisher;
            });
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –ø–µ—Ä–µ–ø–ª—ë—Ç—É
        if (bindingFilter && bindingFilter.value) {
            filtered = filtered.filter(book => {
                const binding = book.binding || '';
                const selectedBinding = bindingFilter.value;

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –ø–µ—Ä–µ–ø–ª—ë—Ç
                return binding === selectedBinding;
            });
        }

        // –§–∏–ª—å—Ç—Ä –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º
        const selectedStores = Array.from(storesFilter.querySelectorAll('input[type="checkbox"]:checked'))
            .map(cb => cb.value);
        if (selectedStores.length > 0) {
            filtered = filtered.filter(book => selectedStores.includes(book.source));
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        filtered.sort((a, b) => {
            switch (sortBy) {
                case 'price_asc':
                    return a.current_price - b.current_price;
                case 'price_desc':
                    return b.current_price - a.current_price;
                case 'discount_desc':
                    return Math.abs(b.discount_percent || 0) - Math.abs(a.discount_percent || 0);
                case 'date_desc':
                    return new Date(b.parsed_at) - new Date(a.parsed_at);
                case 'title_asc':
                    return a.title.localeCompare(b.title, 'ru');
                default:
                    return 0;
            }
        });
        
        filteredBooks = filtered;
        currentPage = 1; // Reset to first page when filters change
        renderBooks();
    }
        
    function renderBooks() {
        const container = document.getElementById('booksGrid');
        
        if (filteredBooks.length === 0) {
            container.style.display = 'none';
            noResults.style.display = 'block';
            booksCount.textContent = '0 –∫–Ω–∏–≥';
            booksPerPageInfo.style.display = 'none';
            paginationContainer.style.display = 'none';
            return;
        }
        
        noResults.style.display = 'none';
        
        // Calculate pagination
        totalPages = Math.ceil(filteredBooks.length / booksPerPage);
        const startIndex = (currentPage - 1) * booksPerPage;
        const endIndex = startIndex + booksPerPage;
        currentPageBooks = filteredBooks.slice(startIndex, endIndex);
        
        // Show books grid
        container.style.display = 'flex';
        booksCount.textContent = `${filteredBooks.length} ${getBooksWord(filteredBooks.length)}`;
        
        // Update pagination info
        shownBooksCount.textContent = currentPageBooks.length;
        totalBooksCount.textContent = filteredBooks.length;
        booksPerPageInfo.style.display = 'block';
        
        // Render books
        container.innerHTML = currentPageBooks.map(book => createBookCard(book)).join('');
        
        // Render pagination
        renderPagination();
        
        // Show pagination if needed
        if (totalPages > 1) {
            paginationContainer.style.display = 'flex';
        } else {
            paginationContainer.style.display = 'none';
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–æ—á–µ–∫
        const cards = container.querySelectorAll('.book-card-compact');
        cards.forEach((card, index) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
                card.style.transition = 'all 0.5s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, index * 50);
        });
    }
    
    function createBookCard(book) {
        // Debug log –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        console.log('Creating book card for:', book.title, {
            discount_percent: book.discount_percent,
            current_price: book.current_price,
            original_price: book.original_price
        });
        
        const hasDiscount = book.discount_percent > 0 && book.original_price && book.original_price > book.current_price;
        const discountPercent = hasDiscount ? book.discount_percent : 0;
        const discountBadge = hasDiscount ? 
            `<span class="discount-badge position-absolute top-0 end-0 m-2 badge bg-danger">-${discountPercent}%</span>` : '';

        const bookImage = book.image_url ? 
            `<img src="${book.image_url}" alt="${book.title}" class="book-cover-img">` :
            `<div class="book-image-placeholder">
                <i class="fas fa-book"></i>
            </div>`;
        
        const formattedCurrentPrice = new Intl.NumberFormat('ru-RU').format(book.current_price) + ' ‚ÇΩ';
        const formattedOriginalPrice = hasDiscount && book.original_price ? 
            new Intl.NumberFormat('ru-RU').format(book.original_price) + ' ‚ÇΩ' : '';
        const formattedDate = new Date(book.parsed_at).toLocaleDateString('ru-RU');
        
        const priceSection = hasDiscount ? `
            <div class="price-section">
                <div class="d-flex align-items-center gap-2">
                    <span class="current-price-discounted fw-bold text-danger">${formattedCurrentPrice}</span>
                    <span class="original-price text-muted text-decoration-line-through">${formattedOriginalPrice}</span>
                </div>
            </div>
        ` : `
            <div class="price-section">
                <span class="current-price-no-discount">${formattedCurrentPrice}</span>
            </div>
        `;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –∫–Ω–æ–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞–ª–∏—á–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        const hasSubscription = userAlerts[book.id];
        console.log(`Book ${book.id} (${book.title}) has subscription: ${hasSubscription ? 'YES' : 'NO'}`);
        
        const subscriptionButton = hasSubscription ? `
            <button class="btn btn-subscribe-compact has-subscription" onclick="event.stopPropagation(); showEditSubscriptionModal(${book.id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" data-book-id="${book.id}" data-button-type="subscription">
                <i class="fas fa-check"></i>
            </button>
        ` : `
            <button class="btn btn-subscribe-compact" onclick="event.stopPropagation(); showSubscribeModal(${book.id})" title="–°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É" data-book-id="${book.id}" data-button-type="subscription">
                <i class="fas fa-bell"></i>
            </button>
        `;
        
        return `
            <div class="book-col-5">
                <div class="book-card-compact h-100 position-relative" onclick="showBookDetails(${book.id})">
                    ${discountBadge}
                    <div class="book-cover-container">
                        ${bookImage}
                    </div>
                    <div class="book-info p-3">
                        <h6 class="book-title mb-2">${escapeHtml(book.title)}</h6>
                        <p class="book-author mb-2">${escapeHtml(book.author)}</p>
                        
                        ${priceSection}
                        
                        ${book.binding ? `
                            <div class="book-binding-info mb-2">
                                <i class="fas fa-book"></i>
                                <small>${escapeHtml(book.binding)}</small>
                            </div>
                        ` : ''}

                        <div class="book-meta mb-3">
                            <small class="book-source">${escapeHtml(book.source)}</small>
                            <small class="text-muted ms-2">${formattedDate}</small>
                        </div>
                        
                        <div class="book-actions d-flex gap-2">
                            <button class="btn btn-details flex-fill" onclick="event.stopPropagation(); showBookDetails(${book.id})">
                                <i class="fas fa-info-circle"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                            </button>
                            ${subscriptionButton}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    function showBookDetails(bookId) {
        const book = currentBooks.find(b => b.id === bookId);
        if (!book) return;
        
        const modalContent = document.getElementById('bookDetailsContent');
        const formattedPrice = new Intl.NumberFormat('ru-RU').format(book.current_price) + ' ‚ÇΩ';
        const formattedDate = new Date(book.parsed_at).toLocaleDateString('ru-RU');
        
        modalContent.innerHTML = `
            <div class="row">
                <div class="col-md-4">
                    ${book.image_url ? 
                        `<img src="${book.image_url}" alt="${escapeHtml(book.title)}" class="img-fluid rounded">` :
                        `<div class="book-image-placeholder text-center py-5">
                            <i class="fas fa-book fa-4x text-muted"></i>
                        </div>`
                    }
                </div>
                <div class="col-md-8">
                    <h4>${escapeHtml(book.title)}</h4>
                    <h6 class="text-muted">${escapeHtml(book.author)}</h6>
                    
                    <div class="row mt-4">
                        <div class="col-sm-6">
                            <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong><br>
                            <span class="fs-4 text-primary">${formattedPrice}</span>
                        </div>
                        <div class="col-sm-6">
                            <strong>–°–∫–∏–¥–∫–∞:</strong><br>
                            <span class="fs-5 text-success">${book.discount_percent}%</span>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <strong>–ú–∞–≥–∞–∑–∏–Ω:</strong> ${escapeHtml(book.source)}<br>
                        <strong>–î–æ–±–∞–≤–ª–µ–Ω–æ:</strong> ${formattedDate}
                    </div>
                    
                    ${book.url ? `
                        <div class="mt-4">
                            <a href="${book.url}" target="_blank" class="btn btn-primary">
                                <i class="fas fa-external-link-alt"></i> –ü–µ—Ä–µ–π—Ç–∏ –≤ –º–∞–≥–∞–∑–∏–Ω
                            </a>
                        </div>
                    ` : ''}
                    
                    <div class="mt-4">
                        <button class="btn btn-subscribe" onclick="showSubscribeModal(${book.id})">
                            <i class="fas fa-bell"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        bookDetailsModal.show();
    }
    
    function showSubscribeModal(bookId) {
        const book = currentBooks.find(b => b.id === bookId);
        if (!book) return;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –≤ —Ä–µ–∂–∏–º —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏
        document.getElementById('subscribeBookTitle').value = `${book.title} - ${book.author}`;
        document.getElementById('subscribeBookId').value = book.id;
        document.getElementById('subscribeBookUrl').value = book.url || '';
        document.getElementById('subscribePrice').value = Math.round(book.current_price * 0.8); // 20% –Ω–∏–∂–µ —Ç–µ–∫—É—â–µ–π —Ü–µ–Ω—ã
        document.getElementById('subscribeDiscount').value = '';
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—É—é –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        const submitBtn = document.querySelector('#subscribeForm button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-bell"></i> –°–æ–∑–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
        
        subscribeModal.show();
    }
    
    async function handleSubscribe(event) {
        event.preventDefault();
        
        const formData = {
            book_id: document.getElementById('subscribeBookId').value,
            target_price: parseFloat(document.getElementById('subscribePrice').value),
            min_discount: document.getElementById('subscribeDiscount').value ? 
                parseFloat(document.getElementById('subscribeDiscount').value) : null
        };
        
        try {
            const response = await fetch('/api/alerts/create-from-book', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            if (response.ok) {
                const result = await response.json();
                showAlert('–ü–æ–¥–ø–∏—Å–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
                subscribeModal.hide();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –∫–Ω–æ–ø–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                if (result.alert) {
                    userAlerts[formData.book_id] = result.alert;
                    console.log(`‚úÖ Created subscription for book ${formData.book_id}, updating button...`);
                    console.log(`üìù Alert details:`, result.alert);
                    
                    // –ù–µ–º–Ω–æ–≥–æ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–Ω–æ–ø–∫–∏
                    setTimeout(() => {
                        updateSubscriptionButton(parseInt(formData.book_id));
                    }, 500);
                }
            } else {
                const error = await response.json();
                showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ' + (error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'danger');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏:', error);
            showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏: ' + error.message, 'danger');
        }
    }
    
    function updateSubscriptionButton(bookId) {
        console.log(`Updating subscription button for book ${bookId}`);
        
        // –ò—â–µ–º –∫–Ω–æ–ø–∫—É –ø–æ data-–∞—Ç—Ä–∏–±—É—Ç—É
        const targetButton = document.querySelector(`button[data-book-id="${bookId}"][data-button-type="subscription"]`);
        
        if (!targetButton) {
            console.log(`Button not found for book ${bookId} using data attributes`);
            
            // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫
            const allButtons = document.querySelectorAll(`button[data-book-id="${bookId}"]`);
            console.log(`Found ${allButtons.length} buttons with data-book-id ${bookId}`);
            
            if (allButtons.length > 0) {
                const targetButton = allButtons[0];
                console.log(`Found button using alternative search for book ${bookId}`);
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
                applySubscriptionAnimation(targetButton, bookId);
            } else {
                console.log(`Button still not found for book ${bookId}, refreshing page...`);
                // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –∫–Ω–æ–ø–∫—É, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
            return;
        }
        
        console.log(`Found target button for book ${bookId}`);
        applySubscriptionAnimation(targetButton, bookId);
    }
    
    function applySubscriptionAnimation(button, bookId) {
        console.log(`Applying animation to button for book ${bookId}`);
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–∞
        button.classList.add('subscribe-button-transition');
        
        // –ü–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –º–µ–Ω—è–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≥–∞–ª–æ—á–∫—É
        setTimeout(() => {
            console.log(`Changing button to subscription state for book ${bookId}`);
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            button.className = 'btn btn-subscribe-compact has-subscription subscribe-button-pulse';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–Ω–æ–ø–∫–∏
            button.innerHTML = '<i class="fas fa-check"></i>';
            button.title = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É';
            button.onclick = (e) => {
                e.stopPropagation();
                showEditSubscriptionModal(bookId);
            };
            
            // –£–±–∏—Ä–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –ø–µ—Ä–µ—Ö–æ–¥–∞
            button.classList.remove('subscribe-button-transition');
            
            // –£–±–∏—Ä–∞–µ–º –ø—É–ª—å—Å–∏—Ä—É—é—â—É—é –∞–Ω–∏–º–∞—Ü–∏—é —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                button.classList.remove('subscribe-button-pulse');
            }, 5000);
            
            console.log(`Button updated successfully for book ${bookId}`);
        }, 800);
    }
    
    function showLoading() {
        isLoading = true;
        loadingState.style.display = 'block';
        booksGrid.style.display = 'none';
        noResults.style.display = 'none';
    }
    
    function hideLoading() {
        isLoading = false;
        loadingState.style.display = 'none';
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ—á–Ω–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã–º –∫–Ω–∏–≥–∞–º
    function checkExactMatch(query, books) {
        const queryWords = query.toLowerCase().split(/\s+/);
        let exactMatches = 0;
        
        books.forEach(book => {
            const author = book.author ? book.author.toLowerCase() : '';
            const title = book.title ? book.title.toLowerCase() : '';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω—ã–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –≤ –∞–≤—Ç–æ—Ä–µ –∏ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const authorMatches = queryWords.filter(word => author.includes(word));
            const titleMatches = queryWords.filter(word => title.includes(word));
            
            // –°—á–∏—Ç–∞–µ–º —Ç–æ—á–Ω—ã–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ–º, –µ—Å–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞–π–¥–µ–Ω—ã –≤ –∞–≤—Ç–æ—Ä–µ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–∏
            const totalMatches = authorMatches.length + titleMatches.length;
            if (totalMatches === queryWords.length) {
                exactMatches++;
            }
        });
        
        // –°—á–∏—Ç–∞–µ–º —Ç–æ—á–Ω—ã–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ–º, –µ—Å–ª–∏ –±–æ–ª–µ–µ –ø–æ–ª–æ–≤–∏–Ω—ã –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ —Ç–æ—á–Ω–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç
        return exactMatches >= Math.ceil(books.length * 0.5);
    }
    
    function checkUrlForAutoBookDetails() {
        // –ü–æ–ª—É—á–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        const urlParams = new URLSearchParams(window.location.search);
        const bookId = urlParams.get('book_id');
        const action = urlParams.get('action');
        
        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–Ω–∏–≥–∏
        if (bookId && action === 'show_details') {
            console.log(`–ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–∫—Ä—ã—Ç—å –∫–Ω–∏–≥—É —Å ID: ${bookId}`);
            
            // –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
            setTimeout(() => {
                const book = currentBooks.find(b => b.id === parseInt(bookId));
                if (book) {
                    console.log(`–û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∫–Ω–∏–≥–∏: ${book.title}`);
                    showBookDetails(parseInt(bookId));
                    
                    // –û—á–∏—â–∞–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è
                    const newUrl = window.location.pathname;
                    window.history.replaceState({}, document.title, newUrl);
                } else {
                    console.log(`–ö–Ω–∏–≥–∞ —Å ID ${bookId} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ`);
                }
            }, 1000); // 1 —Å–µ–∫—É–Ω–¥–∞ –∑–∞–¥–µ—Ä–∂–∫–∏ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
        }
    }
    
    function showSearchStatus(message, type) {
        if (!message || message.trim() === '') {
            // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏ –ø—É—Å—Ç–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
            searchStatus.innerHTML = '';
            return;
        }
        
        searchStatus.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
        
    function showError(message) {
        booksGrid.style.display = 'none';
        noResults.style.display = 'block';
        noResults.innerHTML = `
            <i class="fas fa-exclamation-triangle fa-4x text-danger mb-3"></i>
            <h4 class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h4>
            <p class="text-muted mb-4">${message}</p>
            <button class="btn btn-primary" onclick="loadAllBooks()">
                <i class="fas fa-redo"></i> –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
        `;
    }
    
    function resetFilters() {
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
        priceFilter.value = '';
        discountFilter.value = '';
        sortFilter.value = 'price_asc';
        document.getElementById('genreFilter').value = '';
        document.getElementById('publisherFilter').value = '';
        document.getElementById('bindingFilter').value = '';
        
        // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥
        const checkboxes = storesFilter.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            cb.checked = true;
        });
        
        currentPage = 1; // Reset to first page
    }
    
    function clearAllFilters() {
        searchQuery.value = '';
        priceFilter.value = '';
        discountFilter.value = '';
        sortFilter.value = 'price_asc';
        document.getElementById('genreFilter').value = '';
        document.getElementById('publisherFilter').value = '';
        document.getElementById('bindingFilter').value = '';
        
        // –°–±—Ä–æ—Å –º–∞–≥–∞–∑–∏–Ω–æ–≤
        const checkboxes = storesFilter.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
            if (cb.value === 'chitai-gorod') {
                cb.checked = true;
            } else {
                cb.checked = false;
            }
        });
        
        currentPage = 1; // Reset to first page
        applyFilters();
    }
    
    function renderPagination() {
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        // Adjust start page if end page is at maximum
        if (endPage - startPage + 1 < maxVisiblePages) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        // Create pagination HTML
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
                    <i class="fas fa-chevron-left"></i> –ù–∞–∑–∞–¥
                </a>
            </li>
        `;
        
        // First page
        if (startPage > 1) {
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(1)">1</a>
                </li>
            `;
            if (startPage > 2) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
        }
        
        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            paginationHTML += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        }
        
        // Last page
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
            }
            paginationHTML += `
                <li class="page-item">
                    <a class="page-link" href="#" onclick="changePage(${totalPages})">${totalPages}</a>
                </li>
            `;
        }
        
        // Next button
        paginationHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
                    –í–ø–µ—Ä–µ–¥ <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
        
        pagination.innerHTML = paginationHTML;
        
        // Update pagination info
        const startItem = (currentPage - 1) * booksPerPage + 1;
        const endItem = Math.min(currentPage * booksPerPage, filteredBooks.length);
        paginationInfo.textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages} (–∫–Ω–∏–≥–∏ ${startItem}-${endItem} –∏–∑ ${filteredBooks.length})`;
    }
    
    function changePage(page) {
        if (page < 1 || page > totalPages || page === currentPage) {
            return;
        }
        
        currentPage = page;
        renderBooks();
        
        // Scroll to top of books section
        document.getElementById('booksContainer').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function getBooksWord(count) {
        if (count % 10 === 1 && count % 100 !== 11) return '–∫–Ω–∏–≥–∞';
        if ([2, 3, 4].includes(count % 10) && ![12, 13, 14].includes(count % 100)) return '–∫–Ω–∏–≥–∏';
        return '–∫–Ω–∏–≥';
    }
    
    // Make functions globally available
    window.showBookDetails = showBookDetails;
    window.showSubscribeModal = showSubscribeModal;
    window.loadAllBooks = loadAllBooks;
    window.changePage = changePage;
    window.showAlert = showAlert;
});

// Alert functions
function addAlertContainer() {
    if (!document.getElementById('alertContainer')) {
        const alertContainer = document.createElement('div');
        alertContainer.id = 'alertContainer';
        alertContainer.style.position = 'fixed';
        alertContainer.style.top = '20px';
        alertContainer.style.right = '20px';
        alertContainer.style.zIndex = '9999';
        alertContainer.style.maxWidth = '400px';
        document.body.appendChild(alertContainer);
    }
}

function showAlert(message, type = 'info', duration = 5000) {
    // Create alert element
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show mb-2`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Add to container
    const container = document.getElementById('alertContainer');
    container.appendChild(alertDiv);
    
    // Auto remove after duration
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, duration);
}
</script>
{% endblock %}
