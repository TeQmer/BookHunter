{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-search"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
        </h1>
        
        {% if query %}
        <div class="mb-3">
            <button class="btn btn-outline-primary" onclick="refreshSearchResults()">
                <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            </button>
            <a href="/web/books/search?q={{ query }}" class="btn btn-outline-secondary">
                <i class="fas fa-external-link-alt"></i> –û—Ç–∫—Ä—ã—Ç—å –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ
            </a>
        </div>
        {% endif %}
        
        <!-- –ï–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≤—Å–µ—Ö –∫–Ω–∏–≥ -->
        <div id="booksContainer">
            {% if books and books|length > 0 %}
                <div class="mb-3">
                    <p class="text-muted">–ü–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>{{ query }}</strong>" –Ω–∞–π–¥–µ–Ω–æ {{ total }} –∫–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</p>
                </div>
                <div class="row" id="booksGrid">
                    {% for book in books %}
                    <div class="col-md-4 mb-4">
                        <div class="card book-card h-100">
                            {% if book.image_url %}
                            <img src="{{ book.image_url }}" class="card-img-top" alt="{{ book.title }}" style="height: 200px; object-fit: cover;">
                            {% else %}
                            <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                                <i class="fas fa-book fa-3x text-muted"></i>
                            </div>
                            {% endif %}
                            
                            {% if book.discount_percent %}
                            <div class="discount-badge badge bg-danger">
                                -{{ book.discount_percent }}%
                            </div>
                            {% endif %}
                            
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title">{{ book.title }}</h6>
                                {% if book.author %}
                                <p class="text-muted small mb-2">{{ book.author }}</p>
                                {% endif %}
                                
                                <div class="price-section mb-3">
                                    <span class="current-price">{{ book.display_price }}</span>
                                    {% if book.display_original_price %}
                                    <span class="original-price">{{ book.display_original_price }}</span>
                                    {% endif %}
                                    {% if book.display_discount %}
                                    <span class="badge bg-danger ms-2">{{ book.display_discount }}</span>
                                    {% endif %}
                                </div>
                                
                                <div class="mt-auto">
                                    <small class="text-muted d-block">
                                        <i class="fas fa-store"></i> {{ book.source }}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="fas fa-calendar"></i> {{ book.parsed_at.strftime('%d.%m.%Y') if book.parsed_at else '–ù–µ–¥–∞–≤–Ω–æ' }}
                                    </small>
                                    <div class="mt-2">
                                        <a href="{{ book.url }}" target="_blank" class="btn btn-primary btn-sm">
                                            <i class="fas fa-external-link-alt"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                        </a>
                                        <a href="/web/books/{{ book.id }}" class="btn btn-outline-secondary btn-sm">
                                            <i class="fas fa-info"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <!-- –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞ -->
                <div id="emptyState" class="text-center py-5">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <h3 class="empty-state-title">üîç –ü–æ–∏—Å–∫ –∫–Ω–∏–≥</h3>
                        <p class="empty-state-text">
                            –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏ –∏–ª–∏ –∞–≤—Ç–æ—Ä–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞.
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
        
        <!-- –°—Ç–∞—Ç—É—Å –ø–∞—Ä—Å–∏–Ω–≥–∞ -->
        <div id="parsingStatus" class="mb-4" style="display: none;">
            <div class="card">
                <div class="card-body">
                    <div id="statusContent">
                        <!-- –°—Ç–∞—Ç—É—Å –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5>–ù–æ–≤—ã–π –ø–æ–∏—Å–∫</h5>
                <form method="GET" class="row g-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="q" 
                               value="{{ query }}" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
                    </div>
                    <div class="col-md-3">
                        <select name="source" class="form-select">
                            <option value="chitai-gorod">–ß–∏—Ç–∞–π-–≥–æ—Ä–æ–¥</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –∫–Ω–∏–≥–∏
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuery = "{{ query }}";

// –ê–Ω–∏–º–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–∞ –∫ —ç–ª–µ–º–µ–Ω—Ç—É –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞
document.addEventListener('DOMContentLoaded', function() {
    const searchForm = document.querySelector('form[method="GET"]');
    const parsingStatus = document.getElementById('parsingStatus');
    
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ - —Å–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–µ–º—É
            if (parsingStatus) {
                e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É
                
                const queryInput = searchForm.querySelector('input[name="q"]');
                const query = queryInput ? queryInput.value.trim() : '';
                
                if (query) {
                    // –°–∫—Ä–æ–ª–ª–∏–º –∫ —Å—Ç–∞—Ç—É—Å—É –ø–∞—Ä—Å–∏–Ω–≥–∞ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
                    scrollToParsingStatus();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
                    showParsingStatus('info', 'üîç –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–∏—Å–∫...', `–ò—â–µ–º –∫–Ω–∏–≥–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ç—É—Å–∞
                    parsingStatus.style.display = 'block';
                    
                    // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ–∏—Å–∫
                    startAutomaticSearch(query);
                } else {
                    // –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –ø—É—Å—Ç–æ–π - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –∫–∞–∫ –æ–±—ã—á–Ω–æ
                    return true;
                }
            }
        });
    }
});
                
function scrollToParsingStatus() {
    const statusElement = document.getElementById('parsingStatus');
    if (statusElement) {
        statusElement.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä–æ–ª–ª–∞ –∫ –∑–∞–≥—Ä—É–∑–∫–µ (–º–æ–∂–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –∏–∑–≤–Ω–µ)
window.scrollToLoading = function() {
    scrollToParsingStatus();
};

let currentQuery = "{{ query }}";
let parsingInProgress = false;

console.log('=== SMART SEARCH INITIALIZED ===');
console.log('Current query:', currentQuery);

/**
 * –û—á–∏—â–∞–µ—Ç –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
 * "–ö–æ—Ç–ª–æ–≤–∞–Ω, –ê–Ω–¥—Ä–µ–π –ü–ª–∞—Ç–æ–Ω–æ–≤" -> "–ö–æ—Ç–ª–æ–≤–∞–Ω –ê–Ω–¥—Ä–µ–π –ü–ª–∞—Ç–æ–Ω–æ–≤"
 */
function cleanSearchQuery(text) {
    // –ó–∞–º–µ–Ω—è–µ–º –∑–∞–ø—è—Ç—ã–µ, —Ç–æ—á–∫–∏ –∏ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏ –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
    const cleaned = text.replace(/[,\.\!\?\:\;\-\‚Äî\(\)\[\]\{\}<>]/g, ' ');
    // –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–ª–æ–≤–∞ –∏ –æ—á–∏—â–∞–µ–º –∫–∞–∂–¥—ã–π
    const words = cleaned.toLowerCase().split(/\s+/);
    // –£–±–∏—Ä–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
    return words.filter(word => word.trim()).join(' ');
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –ø–æ–∏—Å–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking if auto search needed...');
    
    const hasBooks = document.querySelector('.book-card');
    const query = currentQuery;
    
    console.log('Page state:', { hasBooks: !!hasBooks, query });
    
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–æ –Ω–µ—Ç –∫–Ω–∏–≥ - –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫
    if (query && !hasBooks && query.trim() !== '') {
        console.log('No books found, starting automatic search...');
        
        // –°–∫—Ä–æ–ª–ª–∏–º –∫ —Å—Ç–∞—Ç—É—Å—É –ø–∞—Ä—Å–∏–Ω–≥–∞ –ø—Ä–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º –∑–∞–ø—É—Å–∫–µ
        setTimeout(() => {
            scrollToParsingStatus();
        }, 500);
        
        startAutomaticSearch(query);
    }
});

async function startAutomaticSearch(query) {
    if (parsingInProgress) {
        console.log('Parsing already in progress, skipping...');
        return;
    }
    
    parsingInProgress = true;
    console.log('Starting automatic search for:', query);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    showParsingStatus('info', 'üîç –ò—â–µ–º –∫–Ω–∏–≥–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ...', `–ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
    try {
        console.log('Checking database...');
        const dbResult = await checkDatabaseForBooks(query);
        
        if (dbResult.booksFound > 0) {
            console.log('Books found in database:', dbResult.booksFound);
            showDatabaseResults(dbResult.books, query, dbResult.booksFound);
            parsingInProgress = false;
            return;
        }
        
        console.log('No books in database, starting parsing...');
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
        await startParsing(query);
        
    } catch (error) {
        console.error('Error in automatic search:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–Ω–∏–≥: ' + error.message);
        parsingInProgress = false;
    }
}

async function checkDatabaseForBooks(query) {
    // –û—á–∏—â–∞–µ–º –∑–∞–ø—Ä–æ—Å –æ—Ç –∑–Ω–∞–∫–æ–≤ –ø—É–Ω–∫—Ç—É–∞—Ü–∏–∏
    const cleanedQuery = cleanSearchQuery(query);
    console.log('Checking database for query:', { original: query, cleaned: cleanedQuery });
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—á–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å
    const response = await fetch(`/web/books/api/search?q=${encodeURIComponent(cleanedQuery)}`);
    
    if (!response.ok) {
        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö');
    }
    
    const result = await response.json();
    console.log('Database check result:', result);
    
    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –≤ –Ω—É–∂–Ω—ã–π –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ showDatabaseResults
    return {
        booksFound: result.books ? result.books.length : 0,
        books: result.books || [],
        total: result.total || 0
    };
}

async function startParsing(query) {
    console.log('Starting parsing for query:', query);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    showParsingStatus('info', 'üîç –ò—â–µ–º –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏...', `–ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–∞–ª–æ–≥ –º–∞–≥–∞–∑–∏–Ω–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"`);
    
    try {
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥
        const response = await fetch(`/api/parser/parse?query=${encodeURIComponent(query)}&source=chitai-gorod`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞');
        }
        
        const result = await response.json();
        const taskId = result.task_id;
        
        if (!taskId) {
            throw new Error('–ù–µ –ø–æ–ª—É—á–µ–Ω ID –∑–∞–¥–∞—á–∏');
        }
        
        console.log('Parsing started with task ID:', taskId);
        
        // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        await trackParsingProgress(taskId, query);
        
    } catch (error) {
        console.error('Parsing error:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + error.message);
    }
}

async function trackParsingProgress(taskId, query) {
    console.log('Tracking parsing progress for task:', taskId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
    showParsingStatus('info', '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã...', '–ò—â–µ–º –∫–Ω–∏–≥–∏ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ –º–∞–≥–∞–∑–∏–Ω–∞');
    
    let attempts = 0;
    const maxAttempts = 30; // 5 –º–∏–Ω—É—Ç –º–∞–∫—Å–∏–º—É–º
    
    const checkStatus = async () => {
        attempts++;
        console.log(`Checking status (attempt ${attempts}/${maxAttempts})...`);
        
        try {
            const response = await fetch(`/api/parser/parse/${taskId}`);
            
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
            
            const status = await response.json();
            console.log('Status check result:', status);
            
            if (status.status === 'completed') {
                console.log('Parsing completed successfully');
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                const dbResult = await checkDatabaseForBooks(query);
                
                if (dbResult.booksFound > 0) {
                    showParsingResults(dbResult.books, query, dbResult.booksFound, status);
                } else {
                    showNoResults(query, status);
                }
                
                parsingInProgress = false;
                
            } else if (status.status === 'failed') {
                console.log('Parsing failed:', status.message);
                showError('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ' + (status.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                parsingInProgress = false;
                
            } else {
                // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –æ–∂–∏–¥–∞–Ω–∏–µ
                if (attempts < maxAttempts) {
                    setTimeout(checkStatus, 10000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
                } else {
                    showTimeout(query);
                    parsingInProgress = false;
                }
            }
            
        } catch (error) {
            console.error('Status check error:', error);
            
            if (attempts < maxAttempts) {
                setTimeout(checkStatus, 10000);
            } else {
                showTimeout(query);
                parsingInProgress = false;
            }
        }
    };
    
    // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(checkStatus, 5000);
}

function showParsingStatus(type, title, message) {
    const statusContainer = document.getElementById('parsingStatus');
    const statusContent = document.getElementById('statusContent');
    
    if (statusContainer && statusContent) {
        const alertClass = type === 'error' ? 'alert-danger' : 
                          type === 'warning' ? 'alert-warning' : 'alert-info';
        
        statusContent.innerHTML = `
            <div class="alert ${alertClass}">
                <h5><i class="fas fa-${type === 'error' ? 'exclamation-circle' : 
                                    type === 'warning' ? 'exclamation-triangle' : 
                                    'info-circle'}"></i> ${title}</h5>
                <p class="mb-0">${message}</p>
            </div>
        `;
        statusContainer.style.display = 'block';
    }
}

function showDatabaseResults(books, query, count) {
    console.log('Showing database results:', { books, query, count });
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    hideParsingStatus();
    
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥
    const booksContainer = document.getElementById('booksContainer');
    booksContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–∏–≥
    const booksGrid = createBooksGrid();
    booksGrid.id = 'booksGrid';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–∏–≥–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    books.forEach((book, index) => {
        setTimeout(() => {
            const bookElement = createBookElement(book);
            booksGrid.appendChild(bookElement);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            bookElement.style.opacity = '0';
            bookElement.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                bookElement.style.transition = 'all 0.5s ease';
                bookElement.style.opacity = '1';
                bookElement.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    booksContainer.innerHTML = `
        <div class="mb-3">
            <p class="text-muted">–ü–æ –∑–∞–ø—Ä–æ—Å—É: "<strong>${query}</strong>" –Ω–∞–π–¥–µ–Ω–æ ${count} –∫–Ω–∏–≥ –≤ –∫–∞—Ç–∞–ª–æ–≥–µ</p>
        </div>
    `;
    booksContainer.appendChild(booksGrid);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showToast(`–ù–∞–π–¥–µ–Ω–æ ${count} –∫–Ω–∏–≥ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"`, 'success');
}

function showParsingResults(books, query, count, status) {
    console.log('Showing parsing results:', { books, query, count, status });
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    hideParsingStatus();
    
    // –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –∫–Ω–∏–≥
    const booksContainer = document.getElementById('booksContainer');
    booksContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –≤—Å–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–∏–≥
    const booksGrid = createBooksGrid();
    booksGrid.id = 'booksGrid';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–∏–≥–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
    books.forEach((book, index) => {
        setTimeout(() => {
            const bookElement = createBookElement(book);
            booksGrid.appendChild(bookElement);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
            bookElement.style.opacity = '0';
            bookElement.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                bookElement.style.transition = 'all 0.5s ease';
                bookElement.style.opacity = '1';
                bookElement.style.transform = 'translateY(0)';
            }, 50);
        }, index * 100);
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    const booksFound = status.books_found || 0;
    const booksAdded = status.books_added || 0;
    const successRate = booksFound > 0 ? Math.round((booksAdded / booksFound) * 100) : 0;
    
    booksContainer.innerHTML = `
        <div class="mb-3">
            <div class="alert alert-success">
                <h5><i class="fas fa-check-circle"></i> –ü–æ–∏—Å–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!</h5>
                <p class="mb-2">–ù–∞–π–¥–µ–Ω–æ <strong>${count} –∫–Ω–∏–≥</strong> –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"</p>
                <ul class="text-muted small mb-0">
                    <li>üîç <strong>–ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ:</strong> ${booksFound} –∫–Ω–∏–≥ —Å–æ —Å–∫–∏–¥–∫–æ–π</li>
                    <li>üìà <strong>–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:</strong> ${successRate}%</li>
                </ul>
            </div>
        </div>
    `;
    booksContainer.appendChild(booksGrid);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showToast(`–ù–∞–π–¥–µ–Ω–æ ${count} –∫–Ω–∏–≥ –ø–æ –∑–∞–ø—Ä–æ—Å—É "${query}"`, 'success');
}

function showNoResults(query, status) {
    console.log('Showing no results for query:', query);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    hideParsingStatus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    const booksContainer = document.getElementById('booksContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (emptyState) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-search"></i>
                </div>
                <h3 class="empty-state-title">üìö –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p class="empty-state-text">
                    –ü–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                </p>
                <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–Ω–∏–≥–∏.</p>
            </div>
        `;
    } else {
        booksContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-search"></i>
                    </div>
                    <h3 class="empty-state-title">üìö –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                    <p class="empty-state-text">
                        –ü–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
                    </p>
                    <p class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–∏—Å–∫–∞—Ç—å –¥—Ä—É–≥–∏–µ –∫–Ω–∏–≥–∏.</p>
                </div>
            </div>
        `;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
    const booksFound = status.books_found || 0;
    const booksAdded = status.books_added || 0;
    
    showParsingStatus('warning', 'üìö –ö–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', `
        –ü–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∫–Ω–∏–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.
        <br><small class="text-muted">üîç –ù–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–∞–π—Ç–µ: ${booksFound} –∫–Ω–∏–≥ —Å–æ —Å–∫–∏–¥–∫–æ–π</small>
    `);
}

function showTimeout(query) {
    console.log('Showing timeout for query:', query);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    hideParsingStatus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–∞–π–º–∞—É—Ç–µ
    const booksContainer = document.getElementById('booksContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (emptyState) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3 class="empty-state-title">‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</h3>
                <p class="empty-state-text">
                    –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å.
                </p>
                <p class="text-muted">–ó–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –µ—â–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ñ–æ–Ω–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
            </div>
        `;
    } else {
        booksContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3 class="empty-state-title">‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è</h3>
                    <p class="empty-state-text">
                        –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å.
                    </p>
                    <p class="text-muted">–ó–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –µ—â–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ñ–æ–Ω–µ. –ü–æ–ø—Ä–æ–±—å—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.</p>
                </div>
            </div>
        `;
    }
    
    showParsingStatus('warning', '‚è∞ –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è', `
        –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É <strong>"${query}"</strong> –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ —á–µ–º –æ–∂–∏–¥–∞–ª–æ—Å—å.
        <br><small class="text-muted">–ó–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç –µ—â–µ –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ —Ñ–æ–Ω–µ.</small>
    `);
}

function showError(message) {
    console.error('Showing error:', message);
    
    // –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–∏—Å–∫–∞
    hideParsingStatus();
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
    const booksContainer = document.getElementById('booksContainer');
    const emptyState = document.getElementById('emptyState');
    
    if (emptyState) {
        emptyState.style.display = 'block';
        emptyState.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-exclamation-circle"></i>
                </div>
                <h3 class="empty-state-title">‚ùå –û—à–∏–±–∫–∞</h3>
                <p class="empty-state-text">
                    ${message}
                </p>
            </div>
        `;
    } else {
        booksContainer.innerHTML = `
            <div class="text-center py-5">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-exclamation-circle"></i>
                    </div>
                    <h3 class="empty-state-title">‚ùå –û—à–∏–±–∫–∞</h3>
                    <p class="empty-state-text">
                        ${message}
                    </p>
                </div>
            </div>
        `;
    }
    
    showParsingStatus('error', '‚ùå –û—à–∏–±–∫–∞', message);
}

function hideParsingStatus() {
    const statusContainer = document.getElementById('parsingStatus');
    if (statusContainer) {
        statusContainer.style.display = 'none';
    }
}

function createBooksGrid() {
    const grid = document.createElement('div');
    grid.className = 'row';
    return grid;
}

function createBookElement(book) {
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-4';
    
    const hasImage = book.image_url && book.image_url.trim() !== '';
    const hasDiscount = book.discount_percent && book.discount_percent > 0;
    
    col.innerHTML = `
        <div class="card book-card h-100 shadow-sm">
            ${hasImage ? `
                <img src="${book.image_url}" class="card-img-top" alt="${book.title}" 
                     style="height: 200px; object-fit: cover;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik04NyA5NUw5MyA4OUw5OSA5NUwxMDUgOTVMMTExIDg5TDExNyA5NUwxMjMgOTVMMTI5IDg5TDEzNSA5NUgxNzBIMTcyVjEyNUg4N1Y5NVoiIGZpbGw9IiM5Q0E0QUYiLz4KPHN2Zz4K'">
            ` : `
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 200px;">
                    <i class="fas fa-book fa-3x text-muted"></i>
                </div>
            `}
            
            ${hasDiscount ? `
                <div class="discount-badge badge bg-danger position-absolute top-0 end-0 m-2">
                    -${book.discount_percent}%
                </div>
            ` : ''}
            
            <div class="card-body d-flex flex-column">
                <h6 class="card-title">${book.title}</h6>
                ${book.author ? `<p class="text-muted small mb-2">${book.author}</p>` : ''}
                
                <div class="price-section mb-3">
                    <span class="current-price fw-bold text-success">${formatPrice(book.current_price)}</span>
                    ${book.original_price && book.original_price > book.current_price ? `
                        <span class="original-price text-muted text-decoration-line-through ms-2">${formatPrice(book.original_price)}</span>
                    ` : ''}
                    ${hasDiscount ? `
                        <span class="badge bg-danger ms-2">-${book.discount_percent}%</span>
                    ` : ''}
                </div>
                
                <div class="mt-auto">
                    <small class="text-muted d-block">
                        <i class="fas fa-store"></i> ${book.source || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                    </small>
                    <small class="text-muted d-block">
                        <i class="fas fa-calendar"></i> ${formatDate(book.parsed_at)}
                    </small>
                    <div class="mt-2">
                        <a href="${book.url}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-external-link-alt"></i> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                        </a>
                        <a href="/web/books/${book.id}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-info"></i> –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    return col;
}

function formatPrice(price) {
    if (!price) return '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞';
    return new Intl.NumberFormat('ru-RU', {
        style: 'currency',
        currency: 'RUB'
    }).format(price);
}

function formatDate(dateString) {
    if (!dateString) return '–ù–µ–¥–∞–≤–Ω–æ';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU');
}

async function refreshSearchResults() {
    console.log('Refreshing search results...');
    window.location.reload();
}

function showToast(message, type = 'info') {
    // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingToasts = document.querySelectorAll('.position-fixed.alert');
    existingToasts.forEach(toast => {
        if (toast.parentNode) {
            toast.parentNode.removeChild(toast);
        }
    });
    
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–µ–∑ –∫—Ä–µ—Å—Ç–∏–∫–∞
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = `
        top: 20px; 
        right: 20px; 
        z-index: 9999; 
        min-width: 300px; 
        max-width: 400px; 
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        border: none;
        border-radius: 8px;
    `;
    toast.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">${message}</div>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 50);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 4 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 4000);
}
</script>
{% endblock %}
