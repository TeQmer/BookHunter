{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-sync"></i> Статус парсинга</h1>
            <a href="/admin" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Назад в админ-панель
            </a>
        </div>
    </div>
</div>

<!-- Общая статистика парсинга -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-list fa-3x text-primary mb-3"></i>
                <h5>Всего операций</h5>
                <p class="display-4 text-primary">{{ total_count }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-check fa-3x text-success mb-3"></i>
                <h5>Успешные</h5>
                <p class="display-4 text-success">{{ completed_count }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-times fa-3x text-danger mb-3"></i>
                <h5>Ошибки</h5>
                <p class="display-4 text-danger">{{ failed_count }}</p>
            </div>
        </div>
    </div>
    
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <i class="fas fa-percentage fa-3x text-info mb-3"></i>
                <h5>Успешность</h5>
                <p class="display-4 text-info">{{ (completed_count / total_count * 100)|round(1) if total_count > 0 else 0 }}%</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Статистика по источникам -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Статистика по источникам
                </h5>
            </div>
            <div class="card-body">
                {% if sources_stats and sources_stats|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Источник</th>
                                <th>Операций</th>
                                <th>Процент</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for source, count in sources_stats.items() %}
                            <tr>
                                <td>
                                    <span class="badge bg-info">{{ source }}</span>
                                </td>
                                <td>{{ count }}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ (count / total_count * 100)|round(1) }}%">
                                            {{ (count / total_count * 100)|round(1) }}%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Нет данных о парсинге</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Последние операции парсинга -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-clock"></i> Последние операции
                </h5>
            </div>
            <div class="card-body">
                {% if parsing_logs and parsing_logs|length > 0 %}
                <div class="list-group list-group-flush">
                    {% for log in parsing_logs %}
                    <div class="list-group-item px-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">{{ log.source or 'Неизвестный источник' }}</h6>
                                <small class="text-muted">
                                    {{ log.created_at.strftime('%d.%m.%Y %H:%M:%S') if log.created_at else 'Не указано' }}
                                </small>
                                {% if log.books_found %}
                                    <br><small class="text-success">Найдено книг: {{ log.books_found }}</small>
                                {% endif %}
                            </div>
                            <span class="badge {% if log.status == 'completed' %}bg-success{% elif log.status == 'failed' %}bg-danger{% else %}bg-warning{% endif %}">
                                {{ log.status }}
                            </span>
                        </div>
                        {% if log.error_message %}
                            <div class="mt-2">
                                <small class="text-danger">
                                    <i class="fas fa-exclamation-triangle"></i> 
                                    {{ log.error_message[:100] }}{% if log.error_message|length > 100 %}...{% endif %}
                                </small>
                            </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                <div class="text-center mt-3">
                    <a href="/admin/logs" class="btn btn-outline-primary btn-sm">
                        Все логи <i class="fas fa-arrow-right"></i>
                    </a>
                </div>
                {% else %}
                <p class="text-muted">Нет данных о последних операциях</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Управление парсингом -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs"></i> Управление парсингом
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-success w-100" onclick="startParsing()">
                            <i class="fas fa-play"></i> Запустить парсинг
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-warning w-100" onclick="stopParsing()">
                            <i class="fas fa-stop"></i> Остановить парсинг
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-info w-100" onclick="refreshStatus()">
                            <i class="fas fa-sync"></i> Обновить статус
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button class="btn btn-outline-secondary w-100" onclick="viewAllLogs()">
                            <i class="fas fa-list"></i> Все логи
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        <strong>Информация:</strong> Парсинг выполняется автоматически в фоновом режиме с помощью Celery workers.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Реальное время мониторинг -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tv"></i> Мониторинг в реальном времени
                </h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleAutoRefresh()">
                        <i class="fas fa-play" id="refreshIcon"></i> 
                        <span id="refreshText">Запустить автообновление</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Статус системы парсинга:</h6>
                        <div id="parsingStatus">
                            <div class="spinner-border spinner-border-sm text-muted" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                            <span class="ms-2">Проверяем статус...</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h6>Последняя активность:</h6>
                        <div id="lastActivity">
                            <span class="text-muted">Загружаем данные...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Автообновление
let autoRefreshEnabled = false;
let refreshInterval;

function startParsing() {
    if (confirm('Запустить парсинг всех источников?')) {
        fetch('/admin/api/start-parsing', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Парсинг запущен!');
                    refreshStatus();
                } else {
                    alert('Ошибка запуска: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка: ' + error);
            });
    }
}

function stopParsing() {
    if (confirm('Остановить текущий парсинг?')) {
        fetch('/admin/api/stop-parsing', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Парсинг остановлен');
                    refreshStatus();
                } else {
                    alert('Ошибка остановки: ' + data.error);
                }
            })
            .catch(error => {
                alert('Ошибка: ' + error);
            });
    }
}

function refreshStatus() {
    fetch('/admin/api/parsing-status')
        .then(response => response.json())
        .then(data => {
            updateParsingStatus(data);
        })
        .catch(error => {
            console.error('Ошибка получения статуса:', error);
        });
}

function updateParsingStatus(data) {
    const statusElement = document.getElementById('parsingStatus');
    const activityElement = document.getElementById('lastActivity');
    
    if (data.active) {
        statusElement.innerHTML = '<span class="badge bg-success"><i class="fas fa-circle"></i> Активен</span>';
    } else {
        statusElement.innerHTML = '<span class="badge bg-secondary"><i class="fas fa-pause"></i> Неактивен</span>';
    }
    
    if (data.last_activity) {
        activityElement.textContent = new Date(data.last_activity).toLocaleString('ru-RU');
    } else {
        activityElement.textContent = 'Нет данных';
    }
}

function toggleAutoRefresh() {
    autoRefreshEnabled = !autoRefreshEnabled;
    const icon = document.getElementById('refreshIcon');
    const text = document.getElementById('refreshText');
    
    if (autoRefreshEnabled) {
        icon.className = 'fas fa-stop';
        text.textContent = 'Остановить автообновление';
        refreshInterval = setInterval(refreshStatus, 5000); // Каждые 5 секунд
    } else {
        icon.className = 'fas fa-play';
        text.textContent = 'Запустить автообновление';
        clearInterval(refreshInterval);
    }
}

function viewAllLogs() {
    window.location.href = '/admin/logs';
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    refreshStatus();
    
    // Автоматическое обновление каждые 30 секунд
    setInterval(refreshStatus, 30000);
});
</script>
{% endblock %}
